---
output:
  html_document:
    code_folding: hide
    css: assets/style.css
    self-contained: no
---
<h1 class="julias-text text-center title-size">CHICAGO RATS BE GONE</h1>
<p class="text-center subtitle-size">Visualizing Chicago's rats infestation and sanitation problems</p>
<hr class="divider">

<h2 class="text-center">Emerging Rat Concerns...</h2>
<p class="text-justify p-size">In recent years, Chicago has been receiving increasing numbers of rodent infestation complaints. It is important for the city government to actively engage in resolving rat complaints, as rats can cause huge property damage and spread harmful pathogens to humans. This exploratory visualization project illustrates the severity and patterns of rat complaints within the city of Chicago, and seeks to help policymakers to find effective measures to mitigate rodent problems.</p>
<br>

<h2 class="text-center">Understand Rat Problems through Graphs</h2>
```{r error=FALSE, warning=FALSE, results='hide', message=FALSE}
# Libraries
library(lubridate)
library(tidyverse)
library(dplyr)
library(gghighlight)
library(ggrepel)
library(ggthemes)
library(readxl)
library(scales)
library(statar)
library(stringr)
library(tidyr)
library(here)
library(httr)
library(jsonlite)
library(magrittr)
```

```{r cache=TRUE, error=FALSE, warning=FALSE, results='hide', message=FALSE}
# Reading in Data
census_tracts <- 
  read_csv(here("data", 
                "tract_community.csv"))

community_numbers <-
  read_excel(here("data", 
                  "community_numbers.xlsx"))

chicago_rodents <- 
  read_csv(here("data", 
                "Chicago_311_Rodent_2014-2018.csv"))

boston_311 <- 
  read_csv(here("data",
                "Boston_311.csv"))

dc_311_2018 <- 
  read_csv(here("data",
                "DC_Service_Requests_2018.csv"))

nyc_rodents_2018 <- 
  read_csv(here("data",
                "NYC_311_Rodent_2018.csv"))

la_rodents_2018 <- 
  read_csv(here("data",
                "LA_Dead_Animal_Removal_2018.csv"))

detroit_rodents_2018 <- 
  read_csv(here("data",
                "Detroit_Rodent_2018.csv"))
```

```{r cache=TRUE, error=FALSE, warning=FALSE, results='hide', message=FALSE}
# Scraping Data from ACS
base <- "https://api.census.gov/data/2016/acs/acs5?"
acs_vars <- "get=B00001_001E,B07013_001E,B07013_003E,B19301_001E"
state_tracts <- "&for=tract:*&in=state:17"
AUTH_TOKEN <- 
  read_delim(here("data", "Auth.txt"), 
             delim = "/", 
         col_names = F)$X1
key <- paste("&key=", AUTH_TOKEN, sep = "")

url <- paste(base, acs_vars, state_tracts, key, sep = "")
response <- GET(url)
all_il_tracts <- 
  jsonlite::fromJSON(content(response, as = "text")) %>%
  data.frame() %>%
  slice(-1)

colnames(all_il_tracts) <- 
  c("Population",
    "Total_Living_In_Area",
    "Renter_Count",
    "Income_Per_Capita",
    "State",
    "County",
    "Tract")
```

```{r error=FALSE, warning=FALSE, results='hide', message=FALSE}
# Preparing Data
census_tracts <-
  census_tracts %>%
  left_join(community_numbers, 
            by = c("Community Area" = "Number"))

chicago_rodents_2018 <-
  chicago_rodents %>%
  filter(year(mdy(`Creation Date`)) == 2018)

boston_rodents_2018 <-
  boston_311 %>%
  filter(str_detect(TYPE, "Rodent"),
         year(open_dt) == 2018)

dc_rodents_2018 <-
  dc_311_2018 %>%
  filter(str_detect(SERVICECODEDESCRIPTION, "Rodent"))

chicago_rat_community_17 <-
  chicago_rodents %>%
  filter(year(mdy(`Creation Date`)) == 2017) %>%
  group_by(`Community Area`) %>%
  summarise(`Number of Complaints` = n()) %>%
  inner_join(community_numbers, by = c("Community Area" = "Number")) %>%
  select(Community, `Number of Complaints`)

to_numeric <- 
  function(column) {
    return(as.numeric(levels(column))[column])
    }

Chicago_communities <- 
  all_il_tracts %>%
  mutate(Census_Tract = str_c(State, County, Tract),
         Total_Income = to_numeric(Income_Per_Capita) * 
                        to_numeric(Population)) %>%
  select(Census_Tract, 
         Population,
         Total_Income,
         Total_Living_In_Area, 
         Renter_Count) %>%
  mutate(Census_Tract = as.numeric(Census_Tract)) %>%
  inner_join(census_tracts, 
             by = c("Census_Tract" = "Census Tract")) %>%
  mutate_at(vars(-"Community",
                 -"Total_Income"), 
            .funs = "to_numeric") %>%
  select(-Census_Tract, -`Community Area`)

Chicago_communities <- 
  Chicago_communities %>%
  group_by(Community) %>%
  summarise_all(.funs = sum) %>%
  mutate(`Income Per Capita` = round(Total_Income / Population, 0),
         `Renter Proportion` = Renter_Count / Total_Living_In_Area) %>%
  select(Community, Population, `Renter Proportion`, `Income Per Capita`)

chicago_rat_community_17 <-
  Chicago_communities %>%
  inner_join(chicago_rat_community_17, by = "Community")

chicago_rat_community_17 %<>%
  mutate(`Number of Requests per 10000 People` = 
           round(`Number of Complaints` / Population * 10000, 0)
         )
```


<h3>"Rat Capital" of United States?</h3>
<p class="text-justify p-size">In 2018, we saw a total of 37577 rat complaints in Chicago. Compared with other major US cities like New York and Los Angeles and cities that were historically troubled by rodent infestations such as Detroit, Chicago appeared to have the largest number of complaints all year round. Rat problems were found to be especially prevalent in the summer.</p>
```{r error=FALSE, warning=FALSE, results='hide', message=FALSE}
# Data Processing for Plot 1
city_mon_summary <- 
  function(df, date_col, city_name) {
    monthly_summary <-
      df %>%
      group_by(month(date_col, 
                   label = TRUE, 
                    abbr = TRUE)) %>%
      summarise(`Number of Complaints` = n(),
                                  City = city_name) %>%
      rename(Month = 1)
    return(monthly_summary)
    }

chicago_months <- 
  city_mon_summary(chicago_rodents_2018,
                   mdy(chicago_rodents_2018$`Creation Date`),
                   "Chicago")

boston_months <- 
  city_mon_summary(boston_rodents_2018,
                   boston_rodents_2018$open_dt,
                   "Boston")

dc_months <- 
  city_mon_summary(dc_rodents_2018,
                   dc_rodents_2018$ADDDATE,
                   "Washington DC")

nyc_months <- 
  city_mon_summary(nyc_rodents_2018,
                   mdy_hms(nyc_rodents_2018$`Created Date`),
                   "New York City")

la_months <-
  city_mon_summary(la_rodents_2018,
                   mdy_hms(la_rodents_2018$CreatedDate),
                   "Los Angeles")

detroit_months <- 
  city_mon_summary(detroit_rodents_2018,
                   mdy_hms(detroit_rodents_2018$`Created At`),
                   "Detroit")

city_months_18 <- 
  bind_rows(chicago_months,
            boston_months,
            dc_months,
            nyc_months,
            la_months,
            detroit_months)
```

```{r error=FALSE, fig.height=7., fig.width=11, message=FALSE, warning=FALSE}
# Plot 1
city_months_18 %>%
  ggplot(aes(x = Month, 
             y = `Number of Complaints`, 
         group = City,
         color = City)) +
  geom_point() +
  geom_line() + 
  geom_line(data = chicago_months,
            size = 1.1) +
  labs(
           title = "Rat Complaints by Highly Affected US Cities in 2018",
        subtitle = "Chicago generally has the most rat complaints all year round",
         caption = "\nSource: City Open Data Portals"
    ) +
  scale_color_manual(values = c("#098154", 
                                "#c72e29",
                                "#016392", 
                                "#be9c2e", 
                                "#fb832d",
                                "#000000")) +
  theme_wsj() +
  theme(
        plot.title = element_text(size = 15,
                                 hjust = 0.42),
     plot.subtitle = element_text(size = 13,
                                 hjust = 0.42),
      plot.caption = element_text(size = 10),
                plot.margin = margin(t = 30, 
                                     r = 30, 
                                     b = 30, 
                                     l = 30, 
                                  unit = "pt"),
        axis.title = element_text(size = 13,
                                  face = "bold")
     ) +
  guides(color = guide_legend(title = NULL))
```

