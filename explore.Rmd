---
output:
  html_document:
    code_folding: hide
    css: assets/css/style.css
    self-contained: no
    includes: 
      in_header: "assets/html/favicon.html"
---
# CHICAGO RATS BE GONE
<p class="text-center subtitle-size">Visualizing Chicago's rats infestation and sanitation problems</p>
<hr class="divider">
```{r error=FALSE, warning=FALSE, results='hide', message=FALSE}
# Libraries
library(lubridate)
library(tidyverse)
library(dplyr)
library(gghighlight)
library(ggrepel)
library(ggthemes)
library(readxl)
library(scales)
library(statar)
library(stringr)
library(tidyr)
library(here)
library(httr)
library(jsonlite)
library(magrittr)
library(grid)
library(ggmap)
```

## Emerging Rat Concerns...
In recent years, Chicago has been receiving increasing numbers of rodent infestation complaints. It is important for the city government to actively engage in resolving rat complaints, as rats can cause huge property damage and spread harmful pathogens to humans. This exploratory visualization project illustrates the severity and patterns of rat complaints within the city of Chicago, and seeks to help policymakers to find effective measures to mitigate rodent problems.
```{r cache=TRUE, error=FALSE, warning=FALSE, results='hide', message=FALSE}
# Reading in Data
census_tracts <- 
  read_csv(here("data", 
                "tract_community.csv"))

community_numbers <-
  read_excel(here("data", 
                  "community_numbers.xlsx"))

chicago_rodents <- 
  read_csv(here("data", 
                "Chicago_311_Rodent_2014-2018.csv"))

boston_311 <- 
  read_csv(here("data",
                "Boston_311.csv"))

dc_311_2018 <- 
  read_csv(here("data",
                "DC_Service_Requests_2018.csv"))

nyc_rodents_2018 <- 
  read_csv(here("data",
                "NYC_311_Rodent_2018.csv"))

la_rodents_2018 <- 
  read_csv(here("data",
                "LA_Dead_Animal_Removal_2018.csv"))

detroit_rodents_2018 <- 
  read_csv(here("data",
                "Detroit_Rodent_2018.csv"))

chicago_sanitation_2018 <- 
  read_csv(here("data",
                "Chicago_311_Sanitation_Violations_2018.csv"))

# Scraping Data from ACS
base <- "https://api.census.gov/data/2016/acs/acs5?"
acs_vars <- "get=B01003_001E,B07013_001E,B07013_003E,B19301_001E"
state_tracts <- "&for=tract:*&in=state:17"
ACS_TOKEN <- 
  read_delim(here("data", "ACSAuth.txt"), 
             delim = "/", 
         col_names = F)$X1
key <- paste("&key=", ACS_TOKEN, sep = "")

url <- paste(base, acs_vars, state_tracts, key, sep = "")
response <- GET(url)
all_il_tracts <- 
  jsonlite::fromJSON(content(response, as = "text")) %>%
  data.frame() %>%
  slice(-1)

colnames(all_il_tracts) <- 
  c("Population",
    "Total_Living_In_Area",
    "Renter_Count",
    "Income_Per_Capita",
    "State",
    "County",
    "Tract")
```

## Understand Rat Problems through Graphs
```{r error=FALSE, warning=FALSE, results='hide', message=FALSE}
# Preparing Data
census_tracts <-
  census_tracts %>%
  left_join(community_numbers, 
            by = c("Community Area" = "Number"))

chicago_rodents_2018 <-
  chicago_rodents %>%
  filter(year(mdy(`Creation Date`)) == 2018)

boston_rodents_2018 <-
  boston_311 %>%
  filter(str_detect(TYPE, "Rodent"),
         year(open_dt) == 2018)

dc_rodents_2018 <-
  dc_311_2018 %>%
  filter(str_detect(SERVICECODEDESCRIPTION, "Rodent"))

chicago_rat_community_17 <-
  chicago_rodents %>%
  filter(year(mdy(`Creation Date`)) == 2017) %>%
  group_by(`Community Area`) %>%
  summarise(`Number of Complaints` = n()) %>%
  inner_join(community_numbers, by = c("Community Area" = "Number")) %>%
  select(Community, `Number of Complaints`)

to_numeric <- 
  function(column) {
    return(as.numeric(levels(column))[column])
    }

Chicago_communities <- 
  all_il_tracts %>%
  mutate(Census_Tract = str_c(State, County, Tract),
         Total_Income = to_numeric(Income_Per_Capita) * 
                        to_numeric(Population)) %>%
  select(Census_Tract, 
         Population,
         Total_Income,
         Total_Living_In_Area, 
         Renter_Count) %>%
  mutate(Census_Tract = as.numeric(Census_Tract)) %>%
  inner_join(census_tracts, 
             by = c("Census_Tract" = "Census Tract")) %>%
  mutate_at(vars(-"Community",
                 -"Total_Income"), 
            .funs = "to_numeric") %>%
  select(-Census_Tract, -`Community Area`)

Chicago_communities <- 
  Chicago_communities %>%
  group_by(Community) %>%
  summarise_all(.funs = sum) %>%
  mutate(`Income Per Capita` = round(Total_Income / Population, 0),
         `Renter Proportion` = Renter_Count / Total_Living_In_Area) %>%
  select(Community, Population, `Renter Proportion`, `Income Per Capita`)

chicago_rat_community_17 <-
  Chicago_communities %>%
  inner_join(chicago_rat_community_17, by = "Community")

chicago_rat_community_17 %<>%
  mutate(`Number of Requests per 10000 People` = 
           `Number of Complaints` / Population * 10000
         )

Chicago_communities

# Plot Custom Theme
custom_theme <-
  theme(
          plot.title = element_text(size = 16,
                                    face = "bold"),
       plot.subtitle = element_text(size = 14),
        plot.caption = element_text(size = 10),
         plot.margin =          margin(t = 30, 
                                       r = 30, 
                                       b = 30, 
                                       l = 30, 
                                    unit = "pt"),
          axis.title = element_text(size = 13,
                                    face = "bold"),
           axis.text = element_text(size = 12,
                                    face = "bold"),
         axis.line.x = element_line(
                                   color = "black",
                                    size = 0.7
                                   ), 
   legend.background = element_rect(fill = "linen"),
          legend.key = element_rect(fill = NA, 
                                   color = NA),
  panel.grid.major.x = element_blank(),
  panel.grid.major.y = element_line(size = 0.6, 
                                   color = "black",
                                linetype = "dotted"),
  panel.grid.minor.x = element_blank(),
  panel.grid.minor.y = element_blank(),
        panel.border = element_blank(),
    panel.background = element_rect(fill = "linen"),
     plot.background = element_rect(fill = "linen")
  )
```

### "Rat Capital" of United States?
In 2018, we saw a total of 37577 rat complaints in Chicago. Compared with other major US cities like New York and Los Angeles and cities that were historically troubled by rodent infestations such as Detroit, Chicago appeared to have the largest number of complaints all year round. From the graph below, we can also see that rat problems were especially prevalent in the summer.
```{r error=FALSE, fig.height=7.5, fig.width=11, message=FALSE, warning=FALSE}
# Data Processing for Plot 1
city_mon_summary <- 
  function(df, date_col, population, city_name) {
    monthly_summary <-
      df %>%
      group_by(month(date_col, 
                   label = TRUE, 
                    abbr = TRUE)) %>%
      summarise(`Number of Complaints` = n(),
                `Number of Complaints per 10000 Population` = 
                  `Number of Complaints` / population * 10000,
                                  City = city_name) %>%
      rename(Month = 1)
    return(monthly_summary)
    }

chicago_months <- 
  city_mon_summary(chicago_rodents_2018,
                   mdy(chicago_rodents_2018$`Creation Date`),
                   2716450,
                   "Chicago")

boston_months <- 
  city_mon_summary(boston_rodents_2018,
                   boston_rodents_2018$open_dt,
                   685094,
                   "Boston")

dc_months <- 
  city_mon_summary(dc_rodents_2018,
                   dc_rodents_2018$ADDDATE,
                   693972,
                   "Washington DC")

nyc_months <- 
  city_mon_summary(nyc_rodents_2018,
                   mdy_hms(nyc_rodents_2018$`Created Date`),
                   8622698,
                   "New York City")

la_months <-
  city_mon_summary(la_rodents_2018,
                   mdy_hms(la_rodents_2018$CreatedDate),
                    3999759,
                   "Los Angeles")

detroit_months <- 
  city_mon_summary(detroit_rodents_2018,
                   mdy_hms(detroit_rodents_2018$`Created At`),
                   673104,
                   "Detroit")

city_months_18 <- 
  bind_rows(chicago_months,
            boston_months,
            dc_months,
            nyc_months,
            la_months,
            detroit_months)

# Plot 1
custom_tt_color <- function(text, color, x, y) {
  annotation_custom(
    grob = textGrob(label = text, 
                    hjust = 0, 
                       gp = gpar(col = color, 
                            fontsize = 16,
                            fontface = "bold")),
    xmin = x, xmax = x,
    ymin = y, ymax = y
  )   
}

p1 <- city_months_18 %>%
  ggplot(aes(x = Month, 
             y = `Number of Complaints per 10000 Population`, 
         group = City,
         color = City)) +
  geom_point() +
  geom_line() + 
  geom_line(data = chicago_months,
            size = 1.1) +
  geom_hline(
      yintercept = 0, 
            size = 0.6,
           color = "black",
        linetype = "dotted"
      ) +
  labs(
           title = " ",
        subtitle = "Rat complaints per 10000 population by highly affected US cities in 2018",
         caption = "\nSource: City Open Data Portals"
    ) +
  scale_color_manual(values = c("#02a06e", # green
                                "#e11f27", # red
                                "#037dae", # blue
                                "#fcb11a", # orange
                                "#543092", # purple
                                "#763f02")) + # brown
  custom_theme +
  theme(     
             plot.title = element_text(hjust = 0.47),
          plot.subtitle = element_text(hjust = 0.47),
        legend.position = "top",
            legend.text = element_text(size = 13)
     ) +
  guides(color = guide_legend(title = NULL)) +
  custom_tt_color("Chicago Has the Most Rat Complaints per 10000 Population All Year Round", "black", 1.3, 25.4) +
  custom_tt_color("Chicago", "#e11f27", 1.3, 25.4)

p1 <- ggplot_gtable(ggplot_build(p1))
p1$layout$clip[p1$layout$name == "panel"] <- "off"
grid.newpage()
grid.draw(p1)
```

### Distribution of Sanitation Code Violations and Rat Complaints
Although rat complaint distribution is not equivalent of the actual rat distribution, Chicago Lincoln Park Zoo has recently conducted <a href="https://www.frontiersin.org/articles/10.3389/fevo.2018.00189/full" target="_blank" class="research_link">research</a> indicating that it can be highly reflective of rodent infestation situation. The research also shows that the abundance of rats is potentially related to the abundance of garbage and other types of sanitation problems. That begs the question where rats and garbage are complained frequently and how much they overlap in different areas of Chicago. As is shown in the map below, we can see that garbage and rats are connected.
```{r error=FALSE, fig.height=7.5, fig.width=11, message=FALSE, warning=FALSE}
GOOGLE_TOKEN = read_delim(here("data", "GoogleAuth.txt"),
                        delim = "/", 
                    col_names = F)$X1

register_google(GOOGLE_TOKEN)

chicago <- get_map("Chicago", 
                maptype = "toner",
                  scale = 4,
                 source = "stamen")

chicago_rodent_geo <-
  chicago_rodents_2018 %>% 
  group_by(Longitude, Latitude) %>%
  summarise(`Complaint Count` = n()) %>%
  filter(`Complaint Count` > 6, !is.na(Longitude)) %>%
  mutate(`Complaint Type` = "Rodent Infestation (>6 Times)")

chicago_sanitation_geo <-
  chicago_sanitation_2018 %>%
  group_by(Longitude, Latitude) %>%
  summarise(`Complaint Count` = n()) %>%
  filter(`Complaint Count` > 3, !is.na(Longitude)) %>%
  mutate(`Complaint Type` = "Sanitation Code Violation (>3 Times)")

chicago_geo <- bind_rows(chicago_rodent_geo,
                         chicago_sanitation_geo)

ggmap(chicago) +
  geom_point(aes(x = `Longitude`,
                 y = `Latitude`,
             color = `Complaint Type`,
              size = `Complaint Count`),
             alpha = 0.75,
              data = chicago_geo) +
  labs(title = "Rodent Infestations Were Generally Located \nnear Places with Sanitation Concerns (2018)",
    subtitle = "The north of Chicago is slightly more infested than the south of Chicago\n",
     caption = "Chicago Data Portal",
           x = "Longitude",
           y = "Latitude") +
  scale_x_continuous(limits = c(-88.03, -87.33), expand = c(0, 0)) +
  scale_y_continuous(limits = c(41.63, 42.05), expand = c(0, 0)) +
  scale_color_manual(values = c("#e11f27", # red
                                "#037dae" # blue
                                )) + 
  custom_theme +
  theme(   plot.title = element_text(hjust = 1.4),
        plot.subtitle = element_text(hjust = 7),
         plot.caption = element_text(hjust = 1.65),
         legend.title = element_text( size = 13, 
                                      face = "bold"),
          legend.text = element_text( size = 12),
          axis.line.y = element_line(color = "black",
                                      size = 0.7))
```

### How Has Response Time Changed Over Years?
The city has become increasingly responsive to rat complaints. In 2016, the mayor's absolute goal for city workers was to respond to all relevant complaints within 5 days, and now it seems that this goal is largely achieved. The bar chart below shows how days to resolve complaints have been decreasing. Starting from 2016, response time has dropped drastically and the number of total rat complaints has also started to go down.
```{r error=FALSE, fig.height=7.5, fig.width=11, message=FALSE, warning=FALSE}
chicago_rodents %>%
  filter(Status == "Completed") %>%
  mutate(Resolving_Days = as.numeric(mdy(`Completion Date`)) - 
                          as.numeric(mdy(`Creation Date`)),
         `Days to Resolve\nRat Complaints` = fct_collapse(
           factor(Resolving_Days),
           "within 3 days" = as.character(0:3),
             "4 to 7 days" = as.character(4:7),
            "8 to 14 days" = as.character(8:14),
           "15 to 30 days" = as.character(15:30),
            "over 30 days" = as.character(31:500)
         ),
          year = year(mdy(`Creation Date`)),
         month = month(mdy(`Creation Date`), 
                       label = TRUE, 
                        abbr = TRUE)
         ) %>%
  group_by(year, month) %>%
  ggplot() +
  geom_bar(aes(x = month, 
            fill = `Days to Resolve\nRat Complaints`),
        position = position_stack(reverse = TRUE)) +
  facet_wrap(vars(year), nrow = 5) +
  labs(title = "Rat Complaint Response Time Has Dropped over\nthe Past Few Years in Chicago (2014 to 2018)",
    subtitle = "Since 2017, most rat complaints are resolved within 7 days",
     caption = "Source: Chicago Data Portal",
           x = "Month",
           y = "Number of Resolved Complaints") +
    scale_fill_manual(values = c("#02a06e",  # green
                                 "#037dae",  # blue
                                 "#fcb11a",  # orange
                                 "#763f02",  # brown
                                 "#e11f27"), # red
                      "Days to Resolve\nRat Complaints") + 
  custom_theme +
  theme(plot.title = element_text(hjust = 0.55),
     plot.subtitle = element_text(hjust = 0.55),
      plot.caption = element_text(hjust = 1.24),
       legend.text = element_text( size = 10),
      legend.title = element_text( size = 12, 
                                   face = "bold"),
        strip.text = element_text( face = "bold",
                                   size = 12),
  strip.background = element_blank())
```

